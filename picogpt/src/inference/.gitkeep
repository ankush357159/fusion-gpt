Generation logic separated from training code.