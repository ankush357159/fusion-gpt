flowchart TD
    A[Input Text] --> B[Tokenizer/BPE Encoder]
    B --> C[Token IDs]
    
    C --> D[Token Embedding Layer]
    D --> E[Embedded Tokens]
    
    E --> F[Transformer Stack N Layers]
    
    F --> G{Loop Through Layers}
    G --> H[Layer i]
    
    H --> H1[RMSNorm / LayerNorm 1]
    H1 --> H2[Grouped-Query Attention GQA]
    
    subgraph GQA["GQA/MHA Details"]
        H2A[Project to Q, K, V]
        H2B[Apply RoPE to Q & K]
        H2C[Compute Attention Scores]
        H2D[KV Cache: Reuse Past Keys/Values]
        H2E[Weighted Sum of Values]
    end
    
    H2 --> H2A
    H2A --> H2B
    H2B --> H2C
    H2C --> H2D
    H2D --> H2E
    
    H2E --> H3[Residual Connection 1]
    H3 --> H4[RMSNorm / LayerNorm 2]
    H4 --> H5[SwiGLU / GELU FFN]
    H5 --> H6[Residual Connection 2]
    
    H6 --> I{More Layers?}
    I -->|Yes| G
    I -->|No| J[Final RMSNorm / LayerNorm]
    
    J --> K[LM Head Unembedding]
    K --> L[Logits Vocab Size]
    
    L --> M[Sampling Pipeline]
    
    subgraph Sampling["Sampling Controls"]
        M1[Temperature Scaling]
        M2[Top-K Filtering]
        M3[Top-P Nucleus Sampling]
        M4[Repetition Penalty]
        M5[Frequency/Presence Penalty]
    end
    
    M --> M1
    M1 --> M2
    M2 --> M3
    M3 --> M4
    M4 --> M5
    
    M5 --> N[Softmax & Sample Token]
    N --> O[Next Token ID]
    
    O --> P{Stopping Criteria?}
    
    subgraph Stopping["Stop Conditions"]
        P1[Max Tokens Reached]
        P2[EOS Token Generated]
        P3[Stop Sequence Found]
    end
    
    P --> P1
    P --> P2
    P --> P3
    
    P -->|Continue| Q[Append to Context]
    Q --> C
    
    P -->|Stop| R[Detokenizer/BPE Decoder]
    R --> S[Output Text]
    
%% subgraph ModelVariants["Architecture Variants"]
%%     V1[GPT-2/3: Learned Pos + LayerNorm + MHA]
%%     V2[Llama 1/2/3: RoPE + RMSNorm + GQA]
%%     V3[GPT-4: Unknown Proprietary]
%% end
    
    style GQA fill:#e1f5ff
    style Sampling fill:#fff4e1
    style Stopping fill:#ffe1e1
    %% style ModelVariants fill:#f0f0f0